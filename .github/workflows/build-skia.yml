name: Build Skia Binaries

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/build-skia.yml' 
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}
    permissions:
      contents: read
    env:
      GN_ARGS: 'is_official_build=true skia_enable_pdf=false skia_use_system_expat=false skia_use_system_libjpeg_turbo=false skia_use_system_libpng=false skia_use_system_libwebp=false skia_use_system_zlib=false skia_use_system_icu=false skia_use_system_harfbuzz=false skia_enable_skparagraph=true'
    strategy:
      fail-fast: true
      matrix:
        config:
          - name: Windows
            os: windows-latest

          - name: macOS
            os: macos-latest

          - name: Android64
            os: ubuntu-latest
            target: Android64
    outputs:
      skia_version: ${{ steps.version.outputs.skia_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install depot_tools (Unix)
        if: runner.os != 'Windows'
        run: |
          # Clone depot_tools - using HEAD as it's designed to auto-update
          git clone \
            https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH
          export PATH="$GITHUB_WORKSPACE/depot_tools:$PATH"

      - name: Install depot_tools (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Clone depot_tools - using HEAD as it's designed to auto-update
          git clone `
            https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$env:GITHUB_WORKSPACE\depot_tools" | `
            Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Set up Android NDK
        if: matrix.config.target == 'Android64'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          local-cache: true

      - name: Install Clang (Unix)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang lld
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV

      - name: Install Clang (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install llvm
          echo "CC=$(brew --prefix llvm)/bin/clang" >> $GITHUB_ENV
          echo "CXX=$(brew --prefix llvm)/bin/clang++" >> $GITHUB_ENV

      - name: Install Clang (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install llvm -y
          # LLVM via choco installs to C:\Program Files\LLVM
          echo "LLVM_HOME=C:\Program Files\LLVM" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Clone Skia
        run: |
          # Clone latest Skia - repository doesn't use stable releases
          git clone --depth 1 https://skia.googlesource.com/skia.git
          cd skia
          python3 tools/git-sync-deps
          python3 bin/fetch-ninja
          python3 bin/fetch-gn

      - name: Get Skia Version
        id: version
        run: |
          cd skia
          # Get version from git short hash
          VERSION=$(git rev-parse --short HEAD)
          echo "skia_version=$VERSION" >> $GITHUB_OUTPUT
          echo "Skia Version: $VERSION"
        shell: bash

      - name: Configure Build (Windows)
        if: matrix.config.name == 'Windows'
        shell: bash
        run: |
          cd skia
          third_party/gn/gn gen out/Release --args='${{ env.GN_ARGS }} is_component_build=false extra_cflags=["/MD"] extra_cflags_cc=["/MD"] target_cpu="x64" clang_win="C:\Program Files\LLVM"'

      - name: Configure Build (macOS)
        if: matrix.config.name == 'macOS'
        shell: bash
        run: |
          cd skia
          third_party/gn/gn gen out/Release --args='${{ env.GN_ARGS }} target_cpu="x64" extra_cflags=["-mmacosx-version-min=10.13"] cc="clang" cxx="clang++"'

      - name: Configure Build (Android64)
        if: matrix.config.target == 'Android64'
        shell: bash
        run: |
          cd skia
          third_party/gn/gn gen out/Release --args='${{ env.GN_ARGS }} skia_use_system_freetype2=false target_os="android" target_cpu="arm64" ndk="'$ANDROID_NDK_HOME'" cc="clang" cxx="clang++"'

      - name: Build Skia (Unix)
        if: runner.os != 'Windows'
        run: |
          cd skia
          ninja -C out/Release

      - name: Build Skia (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd skia
          $env:PATH = "$env:GITHUB_WORKSPACE\depot_tools;$env:PATH"
          ninja -C out/Release

      - name: Package binaries (Unix)
        if: runner.os != 'Windows'
        run: |
          cd skia
          mkdir -p package-bin/lib

          # Copy static libraries only
          cp out/Release/*.a package-bin/lib/ 2>/dev/null || true

          # Verify libraries were built
          if [ -z "$(ls -A package-bin/lib/)" ]; then
            echo "Error: No static libraries were built"
            exit 1
          fi

      - name: Package binaries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd skia
          New-Item -ItemType Directory -Force -Path package-bin/lib

          # Copy static libraries and dll files
          Copy-Item -Path "out/Release/*.lib" -Destination "package-bin/lib/" -ErrorAction SilentlyContinue
          # Copy-Item -Path "out/Release/*.dll" -Destination "package-bin/lib/" -ErrorAction SilentlyContinue

          # Verify at least some libraries were built
          if ((Get-ChildItem package-bin/lib/).Count -eq 0) {
             Write-Error "Error: No static libraries were built"
            exit 1
          }

      - name: Package headers
        # Only package headers once since they're the same across all platforms
        if: matrix.config.name == 'Android64'
        shell: bash
        run: |
          cd skia
          mkdir -p package-headers

          # Copy headers from include directory
          cp -r include package-headers/

          # Copy headers from modules directory
          if [ -d "modules" ]; then
            rsync -av --include="*.hpp" --include="*.h" --filter='-! */' modules package-headers/
          fi

      - name: Create binaries archive (Unix)
        if: runner.os != 'Windows'
        run: |
          cd skia/package-bin
          tar czf ../../skia-${{ matrix.config.name }}-bin.tar.gz .

      - name: Create binaries archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd skia/package-bin
          Compress-Archive -Path * -DestinationPath ../../skia-${{ matrix.config.name }}-bin.zip

      - name: Create headers archive
        # Only create headers archive once since they're the same across all platforms
        if: matrix.config.name == 'Android64'
        shell: bash
        run: |
          cd skia/package-headers
          tar czf ../../skia-headers.tar.gz .

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skia-${{ matrix.config.name }}
          path: |
            skia-*-bin.tar.gz
            skia-*-bin.zip
            skia-headers.tar.gz
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate Release Tag
        id: tag
        run: |
          # Use Skia version from build job, add timestamp for uniqueness
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG="v${{ needs.build.outputs.skia_version }}-${TIMESTAMP}"
          echo "release_tag=$TAG" >> $GITHUB_OUTPUT
          echo "Release Tag: $TAG"

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: >-
            Skia ${{ needs.build.outputs.skia_version }}
            (${{ steps.tag.outputs.release_tag }})
          draft: false
          prerelease: false
          files: artifacts/skia-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
